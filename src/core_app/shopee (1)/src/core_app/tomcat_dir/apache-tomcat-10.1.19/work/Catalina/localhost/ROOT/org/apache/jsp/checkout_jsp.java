/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/10.1.19
 * Generated at: 2026-03-01 13:29:31 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import jakarta.servlet.*;
import jakarta.servlet.http.*;
import jakarta.servlet.jsp.*;
import model.Cart;
import model.CartItem;
import model.User;

public final class checkout_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports,
                 org.apache.jasper.runtime.JspSourceDirectives {

  private static final jakarta.servlet.jsp.JspFactory _jspxFactory =
          jakarta.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.LinkedHashSet<>(3);
    _jspx_imports_packages.add("jakarta.servlet");
    _jspx_imports_packages.add("jakarta.servlet.http");
    _jspx_imports_packages.add("jakarta.servlet.jsp");
    _jspx_imports_classes = new java.util.LinkedHashSet<>(3);
    _jspx_imports_classes.add("model.CartItem");
    _jspx_imports_classes.add("model.User");
    _jspx_imports_classes.add("model.Cart");
  }

  private volatile jakarta.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public boolean getErrorOnELNotFound() {
    return false;
  }

  public jakarta.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final jakarta.servlet.http.HttpServletRequest request, final jakarta.servlet.http.HttpServletResponse response)
      throws java.io.IOException, jakarta.servlet.ServletException {

    if (!jakarta.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      final java.lang.String _jspx_method = request.getMethod();
      if ("OPTIONS".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        return;
      }
      if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET, POST or HEAD. Jasper also permits OPTIONS");
        return;
      }
    }

    final jakarta.servlet.jsp.PageContext pageContext;
    jakarta.servlet.http.HttpSession session = null;
    final jakarta.servlet.ServletContext application;
    final jakarta.servlet.ServletConfig config;
    jakarta.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    jakarta.servlet.jsp.JspWriter _jspx_out = null;
    jakarta.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html;charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");

    Cart cart = (Cart) session.getAttribute("cart");
    User user = (User) session.getAttribute("account");
    if (user == null) { response.sendRedirect("login.jsp"); return; }
    if (cart == null || cart.getItems().isEmpty()) { response.sendRedirect("home"); return; }
    int totalQty = cart.getTotalQuantity();
    java.math.BigDecimal totalMoney = cart.getTotalMoney();


      out.write("\r\n");
      out.write("<!DOCTYPE html>\r\n");
      out.write("<html lang=\"vi\">\r\n");
      out.write("<head>\r\n");
      out.write("    <meta charset=\"UTF-8\">\r\n");
      out.write("    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n");
      out.write("    <title>Thanh Toán - Shopee</title>\r\n");
      out.write("    <link rel=\"stylesheet\" href=\"css/checkout.css\">\r\n");
      out.write("    <link href=\"https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap\" rel=\"stylesheet\">\r\n");
      out.write("    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\r\n");
      out.write("</head>\r\n");
      out.write("<body>\r\n");
      out.write("\r\n");
      out.write("<!-- ===== HEADER ===== -->\r\n");
      out.write("<header class=\"checkout-header\">\r\n");
      out.write("    <div class=\"container header-inner\">\r\n");
      out.write("        <a href=\"home\" class=\"header-logo-link\">\r\n");
      out.write("            <i class=\"fa-solid fa-bag-shopping header-logo-icon\"></i>\r\n");
      out.write("            <span class=\"header-brand\">Shopee</span>\r\n");
      out.write("            <span class=\"header-divider\"></span>\r\n");
      out.write("            <span class=\"header-page-title\">Thanh Toán</span>\r\n");
      out.write("        </a>\r\n");
      out.write("    </div>\r\n");
      out.write("</header>\r\n");
      out.write("\r\n");
      out.write("<main class=\"checkout-main\">\r\n");
      out.write("<div class=\"container checkout-layout\">\r\n");
      out.write("\r\n");
      out.write("<!-- ===== LEFT COLUMN ===== -->\r\n");
      out.write("<div class=\"checkout-left\">\r\n");
      out.write("\r\n");
      out.write("    <!-- 1. ĐỊA CHỈ NHẬN HÀNG -->\r\n");
      out.write("    <section class=\"checkout-section address-section\">\r\n");
      out.write("        <div class=\"section-header address-header\">\r\n");
      out.write("            <div class=\"address-label\">\r\n");
      out.write("                <i class=\"fa-solid fa-location-dot\" style=\"color:#ee4d2d; font-size:18px;\"></i>\r\n");
      out.write("                <span class=\"address-title\">Địa Chỉ Nhận Hàng</span>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"address-body\" id=\"selectedAddressContainer\">\r\n");
      out.write("            <div class=\"address-info\">\r\n");
      out.write("                <span class=\"address-name\">");
      out.print( user.getFullName() );
      out.write("</span>\r\n");
      out.write("                <span class=\"address-phone\">");
      out.print( user.getPhone() != null ? user.getPhone() : "(chưa có SĐT)" );
      out.write("</span>\r\n");
      out.write("                <span class=\"address-badge\">Mặc định</span>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"address-detail\">\r\n");
      out.write("                <span class=\"address-text\">");
      out.print( user.getEmail() );
      out.write("</span>\r\n");
      out.write("                <button type=\"button\" class=\"btn-change\" onclick=\"showAddressModal()\">Thay Đổi</button>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </section>\r\n");
      out.write("\r\n");
      out.write("    <!-- 2. SẢN PHẨM -->\r\n");
      out.write("    <section class=\"checkout-section products-section\">\r\n");
      out.write("        <div class=\"products-table-header\">\r\n");
      out.write("            <div class=\"ptcol-product\">Sản phẩm</div>\r\n");
      out.write("            <div class=\"ptcol-price\">Đơn giá</div>\r\n");
      out.write("            <div class=\"ptcol-qty\">Số lượng</div>\r\n");
      out.write("            <div class=\"ptcol-total\">Thành tiền</div>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <!-- Shop Group -->\r\n");
      out.write("        <div class=\"shop-group\">\r\n");
      out.write("            <div class=\"shop-header-row\">\r\n");
      out.write("                <span class=\"shop-badge-fav\">Yêu thích+</span>\r\n");
      out.write("                <span class=\"shop-name-text\">Shopee Official Store</span>\r\n");
      out.write("                <i class=\"fa-solid fa-message\" style=\"color:#ee4d2d; margin-left:6px; font-size:13px;\"></i>\r\n");
      out.write("            </div>\r\n");
      out.write("\r\n");
      out.write("            ");
 for (CartItem item : cart.getItems()) {
                java.math.BigDecimal oldPrice = item.getPrice().multiply(new java.math.BigDecimal("1.2"));
            
      out.write("\r\n");
      out.write("            <div class=\"product-row\">\r\n");
      out.write("                <div class=\"ptcol-product product-info-col\">\r\n");
      out.write("                    <img src=\"");
      out.print( item.getProduct().getImageUrl() );
      out.write("\" alt=\"");
      out.print( item.getProduct().getName() );
      out.write("\" class=\"product-thumb\" loading=\"lazy\">\r\n");
      out.write("                    <div class=\"product-meta\">\r\n");
      out.write("                        <div class=\"product-name-text\">");
      out.print( item.getProduct().getName() );
      out.write("</div>\r\n");
      out.write("                        <div class=\"product-variant\">Phân loại hàng: Mặc định</div>\r\n");
      out.write("                        <img src=\"https://down-vn.img.susercontent.com/file/vn-50009109-c7a2e1ae720f9704f92f72c9ef1a494a\" style=\"height:14px; margin-top:4px;\" alt=\"freeship\">\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"ptcol-price price-col\">\r\n");
      out.write("                    <span class=\"price-old\">₫");
      out.print( String.format("%,.0f", oldPrice) );
      out.write("</span>\r\n");
      out.write("                    <span class=\"price-new\">₫");
      out.print( String.format("%,.0f", item.getPrice()) );
      out.write("</span>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"ptcol-qty\">");
      out.print( item.getQuantity() );
      out.write("</div>\r\n");
      out.write("                <div class=\"ptcol-total total-col\">₫");
      out.print( String.format("%,.0f", item.getTotalPrice()) );
      out.write("</div>\r\n");
      out.write("            </div>\r\n");
      out.write("            ");
 } 
      out.write("\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <!-- Voucher Row inside products section -->\r\n");
      out.write("        <div class=\"voucher-inline-row\">\r\n");
      out.write("            <div class=\"voucher-inline-left\">\r\n");
      out.write("                <i class=\"fa-solid fa-ticket\" style=\"color:#ee4d2d;\"></i>\r\n");
      out.write("                <span>Voucher của Shop</span>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"voucher-inline-right\" id=\"shopVoucherStatus\">\r\n");
      out.write("                <a href=\"javascript:void(0)\" class=\"voucher-select-link\" onclick=\"showVoucherModal()\">Chọn Voucher</a>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <!-- Message Row -->\r\n");
      out.write("        <div class=\"message-row\">\r\n");
      out.write("            <span class=\"message-label\">Lời nhắn:</span>\r\n");
      out.write("            <input type=\"text\" class=\"message-input\" placeholder=\"Lưu ý cho Người bán...\">\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <!-- Shipping Row -->\r\n");
      out.write("        <div class=\"shipping-method-row\" id=\"shippingDisplay\">\r\n");
      out.write("            <div class=\"shipping-left\">\r\n");
      out.write("                <span class=\"shipping-title\">Phương thức vận chuyển:</span>\r\n");
      out.write("                <div class=\"shipping-detail\">\r\n");
      out.write("                    <span class=\"shipping-type\" id=\"shippingTypeName\">Nhanh</span>\r\n");
      out.write("                    <span class=\"shipping-est\" id=\"shippingEst\">Nhận hàng vào 1 Tháng 3 - 5 Tháng 3</span>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"shipping-right\">\r\n");
      out.write("                <span class=\"shipping-fee-display\" id=\"shippingFeeDisplay\">\r\n");
      out.write("                    <span class=\"shipping-fee-new\" id=\"shippingFeeText\">₫25.500</span>\r\n");
      out.write("                </span>\r\n");
      out.write("                <button type=\"button\" class=\"btn-change-small\" onclick=\"showShippingModal()\">THAY ĐỔI</button>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <!-- Order total mini -->\r\n");
      out.write("        <div class=\"order-mini-total\">\r\n");
      out.write("            <span>Tổng số tiền (");
      out.print( totalQty );
      out.write(" sản phẩm):</span>\r\n");
      out.write("            <span class=\"order-mini-amount\">₫");
      out.print( String.format("%,.0f", totalMoney) );
      out.write("</span>\r\n");
      out.write("        </div>\r\n");
      out.write("    </section>\r\n");
      out.write("\r\n");
      out.write("    <!-- 3. SHOPEE VOUCHER + XU -->\r\n");
      out.write("    <section class=\"checkout-section platform-voucher-section\">\r\n");
      out.write("        <div class=\"platform-voucher-row\">\r\n");
      out.write("            <div class=\"pv-left\">\r\n");
      out.write("                <i class=\"fa-solid fa-ticket\" style=\"color:#ee4d2d; font-size:16px;\"></i>\r\n");
      out.write("                <span class=\"pv-label\">Shopee Voucher</span>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"pv-right\" id=\"platformVoucherStatus\">\r\n");
      out.write("                <a href=\"javascript:void(0)\" class=\"pv-link\" onclick=\"showPlatformVoucherModal()\">Chọn hoặc nhập mã</a>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"platform-xu-row\">\r\n");
      out.write("            <div class=\"px-left\">\r\n");
      out.write("                <i class=\"fa-solid fa-coins\" style=\"color:#f6a700; font-size:16px;\"></i>\r\n");
      out.write("                <span class=\"px-label\">Shopee Xu</span>\r\n");
      out.write("                <span class=\"px-hint\">Không thể dùng xu</span>\r\n");
      out.write("            </div>\r\n");
      out.write("            <span class=\"px-value\">-₫0</span>\r\n");
      out.write("        </div>\r\n");
      out.write("    </section>\r\n");
      out.write("\r\n");
      out.write("    <!-- 4. PHƯƠNG THỨC THANH TOÁN -->\r\n");
      out.write("    <section class=\"checkout-section payment-section\">\r\n");
      out.write("        <div class=\"payment-header\">\r\n");
      out.write("            <span class=\"payment-title\">Phương thức thanh toán</span>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"payment-options\">\r\n");
      out.write("            <label class=\"payment-option active\" data-method=\"cod\">\r\n");
      out.write("                <input type=\"radio\" name=\"paymentMethod\" value=\"COD\" checked>\r\n");
      out.write("                <span class=\"payment-option-label\">Thanh toán khi nhận hàng</span>\r\n");
      out.write("            </label>\r\n");
      out.write("            <label class=\"payment-option\" data-method=\"wallet\">\r\n");
      out.write("                <input type=\"radio\" name=\"paymentMethod\" value=\"WALLET\">\r\n");
      out.write("                <span class=\"payment-option-label\">Ví ShopeePay</span>\r\n");
      out.write("            </label>\r\n");
      out.write("            <label class=\"payment-option\" data-method=\"card\">\r\n");
      out.write("                <input type=\"radio\" name=\"paymentMethod\" value=\"CARD\">\r\n");
      out.write("                <span class=\"payment-option-label\">Thẻ Tín dụng/Ghi nợ</span>\r\n");
      out.write("            </label>\r\n");
      out.write("            <label class=\"payment-option\" data-method=\"transfer\">\r\n");
      out.write("                <input type=\"radio\" name=\"paymentMethod\" value=\"TRANSFER\">\r\n");
      out.write("                <span class=\"payment-option-label\">Chuyển khoản ngân hàng</span>\r\n");
      out.write("            </label>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"payment-cod-notice\" id=\"codNotice\">\r\n");
      out.write("            <i class=\"fa-solid fa-circle-info\" style=\"color:#ee4d2d;\"></i>\r\n");
      out.write("            Phí thu hộ: ₫0 VNĐ. Ưu đãi về phí vận chuyển (nếu có) áp dụng cả với phí thu hộ.\r\n");
      out.write("        </div>\r\n");
      out.write("    </section>\r\n");
      out.write("\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<!-- ===== RIGHT COLUMN - STICKY SUMMARY ===== -->\r\n");
      out.write("<div class=\"checkout-right\">\r\n");
      out.write("    <div class=\"order-summary-sticky\">\r\n");
      out.write("        <div class=\"summary-title\">Chi Tiết Thanh Toán</div>\r\n");
      out.write("\r\n");
      out.write("        <div class=\"summary-line\">\r\n");
      out.write("            <span>Tổng tiền hàng</span>\r\n");
      out.write("            <span id=\"summarySubtotal\">₫");
      out.print( String.format("%,.0f", totalMoney) );
      out.write("</span>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"summary-line\">\r\n");
      out.write("            <span>Phí vận chuyển</span>\r\n");
      out.write("            <span id=\"summaryShipping\">₫25.500</span>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"summary-line discount-line\" id=\"summaryVoucherLine\">\r\n");
      out.write("            <span>Giảm giá voucher</span>\r\n");
      out.write("            <span class=\"discount-value\" id=\"summaryVoucherDiscount\">-₫0</span>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"summary-line discount-line\" id=\"summaryShipDiscountLine\" style=\"display:none;\">\r\n");
      out.write("            <span>Giảm giá phí vận chuyển</span>\r\n");
      out.write("            <span class=\"discount-value\" id=\"summaryShipDiscount\">-₫0</span>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <div class=\"summary-divider\"></div>\r\n");
      out.write("\r\n");
      out.write("        <div class=\"summary-total-line\">\r\n");
      out.write("            <span>Tổng thanh toán</span>\r\n");
      out.write("            <span class=\"summary-total-amount\" id=\"summaryGrandTotal\">₫");
      out.print( String.format("%,.0f", totalMoney.add(new java.math.BigDecimal("25500"))) );
      out.write("</span>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <form action=\"checkout\" method=\"post\" id=\"checkoutForm\">\r\n");
      out.write("            <button type=\"submit\" class=\"btn-order\" id=\"btnPlaceOrder\">\r\n");
      out.write("                Đặt hàng\r\n");
      out.write("            </button>\r\n");
      out.write("        </form>\r\n");
      out.write("\r\n");
      out.write("        <div class=\"summary-note\">\r\n");
      out.write("            Nhấn \"Đặt hàng\" đồng nghĩa với việc bạn đồng ý tuân theo\r\n");
      out.write("            <a href=\"javascript:void(0)\">Điều khoản Shopee</a>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("</div>\r\n");
      out.write("</main>\r\n");
      out.write("\r\n");
      out.write("<!-- ===== ADDRESS MODAL (LIST) ===== -->\r\n");
      out.write("<div class=\"modal-overlay\" id=\"addressModal\">\r\n");
      out.write("    <div class=\"modal-box address-list-modal\">\r\n");
      out.write("        <div class=\"modal-header\">\r\n");
      out.write("            <h3>Địa Chỉ Của Tôi</h3>\r\n");
      out.write("            <button class=\"modal-close\" onclick=\"closeAddressModal()\"><i class=\"fa-solid fa-xmark\"></i></button>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-body\" id=\"addressListContainer\">\r\n");
      out.write("            <!-- JS Rendered -->\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-footer footer-space-between\">\r\n");
      out.write("            <button class=\"btn-add-new-address\" onclick=\"showNewAddressModal()\">\r\n");
      out.write("                <i class=\"fa-solid fa-plus\"></i> Thêm Địa Chỉ Mới\r\n");
      out.write("            </button>\r\n");
      out.write("            <div class=\"footer-actions\">\r\n");
      out.write("                <button class=\"btn-modal-cancel\" onclick=\"closeAddressModal()\">Hủy</button>\r\n");
      out.write("                <button class=\"btn-modal-confirm\" onclick=\"confirmAddressSelection()\">Xác Nhận</button>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<!-- ===== NEW ADDRESS MODAL ===== -->\r\n");
      out.write("<div class=\"modal-overlay\" id=\"newAddressModal\">\r\n");
      out.write("    <div class=\"modal-box new-address-modal\">\r\n");
      out.write("        <div class=\"modal-header\">\r\n");
      out.write("            <h3>Địa chỉ mới (dùng thông tin trước sáp nhập)</h3>\r\n");
      out.write("            <button class=\"modal-close\" onclick=\"closeNewAddressModal()\"><i class=\"fa-solid fa-xmark\"></i></button>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-body new-address-body\">\r\n");
      out.write("            <div class=\"form-row-2\">\r\n");
      out.write("                <input type=\"text\" id=\"newAddrName\" class=\"shopee-input\" placeholder=\"Họ và tên\">\r\n");
      out.write("                <input type=\"text\" id=\"newAddrPhone\" class=\"shopee-input\" placeholder=\"Số điện thoại\">\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"form-row-1\">\r\n");
      out.write("                <select id=\"newAddrCity\" class=\"shopee-select\">\r\n");
      out.write("                    <option value=\"\">Tỉnh/ Thành phố, Quận/Huyện, Phường/Xã</option>\r\n");
      out.write("                    <option value=\"Phường Đống Đa, Thành Phố Quy Nhơn, Bình Định\">Phường Đống Đa, Thành Phố Quy Nhơn, Bình Định</option>\r\n");
      out.write("                    <option value=\"Hà Nội\">Hà Nội</option>\r\n");
      out.write("                    <option value=\"TP. Hồ Chí Minh\">TP. Hồ Chí Minh</option>\r\n");
      out.write("                </select>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"form-row-1\">\r\n");
      out.write("                <textarea id=\"newAddrDetail\" class=\"shopee-textarea\" placeholder=\"Địa chỉ cụ thể\" rows=\"2\"></textarea>\r\n");
      out.write("            </div>\r\n");
      out.write("            \r\n");
      out.write("            <div class=\"map-placeholder\">\r\n");
      out.write("                <button class=\"btn-add-location\"><i class=\"fa-solid fa-plus\"></i> Thêm vị trí</button>\r\n");
      out.write("            </div>\r\n");
      out.write("\r\n");
      out.write("            <div class=\"address-type-group\">\r\n");
      out.write("                <div class=\"address-type-label\">Loại địa chỉ:</div>\r\n");
      out.write("                <div class=\"type-buttons\">\r\n");
      out.write("                    <button class=\"btn-addr-type active\" onclick=\"selectAddrType(this, 'Nhà Riêng')\">Nhà Riêng</button>\r\n");
      out.write("                    <button class=\"btn-addr-type\" onclick=\"selectAddrType(this, 'Văn Phòng')\">Văn Phòng</button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("\r\n");
      out.write("            <label class=\"default-checkbox-label\">\r\n");
      out.write("                <input type=\"checkbox\" id=\"newAddrDefault\" class=\"shopee-checkbox\">\r\n");
      out.write("                <span class=\"checkbox-text\">Đặt làm địa chỉ mặc định</span>\r\n");
      out.write("            </label>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-footer footer-right\">\r\n");
      out.write("            <button class=\"btn-modal-back\" onclick=\"closeNewAddressModal()\">Trở Lại</button>\r\n");
      out.write("            <button class=\"btn-modal-confirm\" onclick=\"saveNewAddress()\">Hoàn thành</button>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<!-- ===== VOUCHER MODAL (SHOP) ===== -->\r\n");
      out.write("<div class=\"modal-overlay\" id=\"voucherModal\">\r\n");
      out.write("    <div class=\"modal-box voucher-modal-box\">\r\n");
      out.write("        <div class=\"modal-header\">\r\n");
      out.write("            <h3><i class=\"fa-solid fa-ticket\" style=\"color:#ee4d2d; margin-right:8px;\"></i>Voucher của Shop</h3>\r\n");
      out.write("            <button class=\"modal-close\" onclick=\"closeVoucherModal()\"><i class=\"fa-solid fa-xmark\"></i></button>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-body voucher-modal-body\">\r\n");
      out.write("            <div class=\"voucher-input-row\">\r\n");
      out.write("                <input type=\"text\" id=\"shopVoucherCode\" class=\"shopee-input voucher-code-input\" placeholder=\"Nhập mã voucher của Shop\">\r\n");
      out.write("                <button class=\"btn-apply-voucher\" onclick=\"applyShopVoucherCode()\">ÁP DỤNG</button>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"voucher-section-label\">Voucher có sẵn</div>\r\n");
      out.write("            <div class=\"voucher-list\" id=\"shopVoucherList\">\r\n");
      out.write("                <!-- Rendered by JS -->\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-footer footer-right\">\r\n");
      out.write("            <button class=\"btn-modal-cancel\" onclick=\"closeVoucherModal()\">Trở Lại</button>\r\n");
      out.write("            <button class=\"btn-modal-confirm\" onclick=\"confirmShopVoucher()\">OK</button>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<!-- ===== PLATFORM VOUCHER MODAL ===== -->\r\n");
      out.write("<div class=\"modal-overlay\" id=\"platformVoucherModal\">\r\n");
      out.write("    <div class=\"modal-box voucher-modal-box\">\r\n");
      out.write("        <div class=\"modal-header\">\r\n");
      out.write("            <h3><i class=\"fa-solid fa-ticket\" style=\"color:#ee4d2d; margin-right:8px;\"></i>Shopee Voucher</h3>\r\n");
      out.write("            <button class=\"modal-close\" onclick=\"closePlatformVoucherModal()\"><i class=\"fa-solid fa-xmark\"></i></button>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-body voucher-modal-body\">\r\n");
      out.write("            <div class=\"voucher-input-row\">\r\n");
      out.write("                <input type=\"text\" id=\"platformVoucherCode\" class=\"shopee-input voucher-code-input\" placeholder=\"Nhập mã Shopee Voucher\">\r\n");
      out.write("                <button class=\"btn-apply-voucher\" onclick=\"applyPlatformVoucherCode()\">ÁP DỤNG</button>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"voucher-section-label\">Voucher có sẵn</div>\r\n");
      out.write("            <div class=\"voucher-list\" id=\"platformVoucherList\">\r\n");
      out.write("                <!-- Rendered by JS -->\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-footer footer-right\">\r\n");
      out.write("            <button class=\"btn-modal-cancel\" onclick=\"closePlatformVoucherModal()\">Trở Lại</button>\r\n");
      out.write("            <button class=\"btn-modal-confirm\" onclick=\"confirmPlatformVoucher()\">OK</button>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<!-- ===== SHIPPING MODAL ===== -->\r\n");
      out.write("<div class=\"modal-overlay\" id=\"shippingModal\">\r\n");
      out.write("    <div class=\"modal-box shipping-modal-box\">\r\n");
      out.write("        <div class=\"modal-header\">\r\n");
      out.write("            <h3><i class=\"fa-solid fa-truck\" style=\"color:#26aa99; margin-right:8px;\"></i>Chọn Phương Thức Vận Chuyển</h3>\r\n");
      out.write("            <button class=\"modal-close\" onclick=\"closeShippingModal()\"><i class=\"fa-solid fa-xmark\"></i></button>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-body shipping-modal-body\">\r\n");
      out.write("            <div class=\"shipping-options-list\" id=\"shippingOptionsList\">\r\n");
      out.write("                <!-- Rendered by JS -->\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-footer footer-right\">\r\n");
      out.write("            <button class=\"btn-modal-cancel\" onclick=\"closeShippingModal()\">Hủy</button>\r\n");
      out.write("            <button class=\"btn-modal-confirm\" onclick=\"confirmShipping()\">Hoàn Thành</button>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<script>\r\n");
      out.write("    // ===== GLOBAL STATE =====\r\n");
      out.write("    const TOTAL_MONEY = ");
      out.print( totalMoney );
      out.write(";\r\n");
      out.write("    let selectedShopVoucherId = null;\r\n");
      out.write("    let tempShopVoucherId = null;\r\n");
      out.write("    let selectedPlatformVoucherId = null;\r\n");
      out.write("    let tempPlatformVoucherId = null;\r\n");
      out.write("    let selectedShippingId = 'fast';\r\n");
      out.write("    let tempShippingId = 'fast';\r\n");
      out.write("\r\n");
      out.write("    // ===== VOUCHER DATA =====\r\n");
      out.write("    const shopVouchers = [\r\n");
      out.write("        { id: 'sv1', code: 'SHOP15K', label: 'Giảm ₫15.000', desc: 'Đơn tối thiểu ₫100.000', type: 'fixed', value: 15000, minOrder: 100000 },\r\n");
      out.write("        { id: 'sv2', code: 'SHOP10P', label: 'Giảm 10%', desc: 'Giảm tối đa ₫30.000 - Đơn tối thiểu ₫200.000', type: 'percent', value: 10, maxDiscount: 30000, minOrder: 200000 },\r\n");
      out.write("        { id: 'sv3', code: 'SHOP50K', label: 'Giảm ₫50.000', desc: 'Đơn tối thiểu ₫500.000', type: 'fixed', value: 50000, minOrder: 500000 }\r\n");
      out.write("    ];\r\n");
      out.write("\r\n");
      out.write("    const platformVouchers = [\r\n");
      out.write("        { id: 'pv1', code: 'SHOPEE10K', label: 'Giảm ₫10.000', desc: 'Đơn tối thiểu ₫50.000', type: 'fixed', value: 10000, minOrder: 50000 },\r\n");
      out.write("        { id: 'pv2', code: 'SHOPEE5P', label: 'Giảm 5%', desc: 'Giảm tối đa ₫20.000 - Đơn tối thiểu ₫150.000', type: 'percent', value: 5, maxDiscount: 20000, minOrder: 150000 },\r\n");
      out.write("        { id: 'pv3', code: 'FREESHIP', label: 'Miễn phí vận chuyển', desc: 'Giảm tối đa ₫25.000 phí ship', type: 'freeship', value: 25000, minOrder: 0 }\r\n");
      out.write("    ];\r\n");
      out.write("\r\n");
      out.write("    // ===== SHIPPING DATA =====\r\n");
      out.write("    const shippingMethods = [\r\n");
      out.write("        { id: 'fast', name: 'Nhanh', fee: 25500, est: '2-4 ngày', estText: 'Nhận hàng vào 1 Tháng 3 - 5 Tháng 3', icon: 'fa-truck-fast', color: '#26aa99' },\r\n");
      out.write("        { id: 'economy', name: 'Tiết kiệm', fee: 16500, est: '4-7 ngày', estText: 'Nhận hàng vào 3 Tháng 3 - 8 Tháng 3', icon: 'fa-box', color: '#05a' },\r\n");
      out.write("        { id: 'express', name: 'Hỏa tốc', fee: 45000, est: '1-2 ngày', estText: 'Nhận hàng vào 28 Tháng 2 - 1 Tháng 3', icon: 'fa-bolt', color: '#ee4d2d' },\r\n");
      out.write("        { id: 'bulky', name: 'Hàng cồng kềnh', fee: 35000, est: '3-5 ngày', estText: 'Nhận hàng vào 2 Tháng 3 - 6 Tháng 3', icon: 'fa-truck-moving', color: '#8B5CF6' }\r\n");
      out.write("    ];\r\n");
      out.write("\r\n");
      out.write("    // ===== UTILITY FUNCTIONS =====\r\n");
      out.write("    function formatVND(num) {\r\n");
      out.write("        return '₫' + Math.round(num).toLocaleString('vi-VN');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function calcVoucherDiscount(voucher) {\r\n");
      out.write("        if (!voucher) return 0;\r\n");
      out.write("        if (TOTAL_MONEY < voucher.minOrder) return 0;\r\n");
      out.write("        if (voucher.type === 'fixed') return voucher.value;\r\n");
      out.write("        if (voucher.type === 'percent') {\r\n");
      out.write("            let d = TOTAL_MONEY * voucher.value / 100;\r\n");
      out.write("            return Math.min(d, voucher.maxDiscount || d);\r\n");
      out.write("        }\r\n");
      out.write("        if (voucher.type === 'freeship') return 0; // handled separately\r\n");
      out.write("        return 0;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function calcFreeshipDiscount(voucher, shippingFee) {\r\n");
      out.write("        if (!voucher || voucher.type !== 'freeship') return 0;\r\n");
      out.write("        return Math.min(voucher.value, shippingFee);\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    // ===== UPDATE SUMMARY =====\r\n");
      out.write("    function updateSummary() {\r\n");
      out.write("        const ship = shippingMethods.find(s => s.id === selectedShippingId) || shippingMethods[0];\r\n");
      out.write("        const shopV = shopVouchers.find(v => v.id === selectedShopVoucherId);\r\n");
      out.write("        const platV = platformVouchers.find(v => v.id === selectedPlatformVoucherId);\r\n");
      out.write("\r\n");
      out.write("        const shippingFee = ship.fee;\r\n");
      out.write("        const shopDiscount = calcVoucherDiscount(shopV);\r\n");
      out.write("        const platDiscount = calcVoucherDiscount(platV);\r\n");
      out.write("        const freeshipDiscount = calcFreeshipDiscount(platV, shippingFee);\r\n");
      out.write("        const totalVoucherDiscount = shopDiscount + platDiscount;\r\n");
      out.write("        const grandTotal = TOTAL_MONEY + shippingFee - totalVoucherDiscount - freeshipDiscount;\r\n");
      out.write("\r\n");
      out.write("        document.getElementById('summarySubtotal').textContent = formatVND(TOTAL_MONEY);\r\n");
      out.write("        document.getElementById('summaryShipping').textContent = formatVND(shippingFee);\r\n");
      out.write("        document.getElementById('summaryVoucherDiscount').textContent = '-' + formatVND(totalVoucherDiscount);\r\n");
      out.write("        document.getElementById('summaryVoucherLine').style.display = totalVoucherDiscount > 0 ? 'flex' : 'flex';\r\n");
      out.write("\r\n");
      out.write("        if (freeshipDiscount > 0) {\r\n");
      out.write("            document.getElementById('summaryShipDiscountLine').style.display = 'flex';\r\n");
      out.write("            document.getElementById('summaryShipDiscount').textContent = '-' + formatVND(freeshipDiscount);\r\n");
      out.write("        } else {\r\n");
      out.write("            document.getElementById('summaryShipDiscountLine').style.display = 'none';\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        document.getElementById('summaryGrandTotal').textContent = formatVND(Math.max(0, grandTotal));\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    // ===== SHOP VOUCHER MODAL =====\r\n");
      out.write("    function renderShopVouchers() {\r\n");
      out.write("        const container = document.getElementById('shopVoucherList');\r\n");
      out.write("        container.innerHTML = '';\r\n");
      out.write("        shopVouchers.forEach(v => {\r\n");
      out.write("            const eligible = TOTAL_MONEY >= v.minOrder;\r\n");
      out.write("            const isSelected = v.id === tempShopVoucherId;\r\n");
      out.write("            const html = ''\r\n");
      out.write("                + '<div class=\"voucher-card ' + (isSelected ? 'selected' : '') + ' ' + (!eligible ? 'disabled' : '') + '\" onclick=\"' + (eligible ? 'selectShopVoucher(\\'' + v.id + '\\')' : '') + '\">'\r\n");
      out.write("                + '  <div class=\"voucher-card-left\">'\r\n");
      out.write("                + '    <div class=\"voucher-card-icon\"><i class=\"fa-solid fa-tag\"></i></div>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '  <div class=\"voucher-card-body\">'\r\n");
      out.write("                + '    <div class=\"voucher-card-title\">' + v.label + '</div>'\r\n");
      out.write("                + '    <div class=\"voucher-card-desc\">' + v.desc + '</div>'\r\n");
      out.write("                + '    <div class=\"voucher-card-code\">Mã: ' + v.code + '</div>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '  <div class=\"voucher-card-radio\">'\r\n");
      out.write("                + '    <input type=\"radio\" name=\"shopVoucherSelect\" ' + (isSelected ? 'checked' : '') + ' ' + (!eligible ? 'disabled' : '') + '>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '</div>';\r\n");
      out.write("            container.insertAdjacentHTML('beforeend', html);\r\n");
      out.write("        });\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function selectShopVoucher(id) {\r\n");
      out.write("        tempShopVoucherId = (tempShopVoucherId === id) ? null : id;\r\n");
      out.write("        renderShopVouchers();\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function showVoucherModal() {\r\n");
      out.write("        tempShopVoucherId = selectedShopVoucherId;\r\n");
      out.write("        renderShopVouchers();\r\n");
      out.write("        document.getElementById('voucherModal').classList.add('show');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function closeVoucherModal() {\r\n");
      out.write("        document.getElementById('voucherModal').classList.remove('show');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function confirmShopVoucher() {\r\n");
      out.write("        selectedShopVoucherId = tempShopVoucherId;\r\n");
      out.write("        updateShopVoucherDisplay();\r\n");
      out.write("        updateSummary();\r\n");
      out.write("        closeVoucherModal();\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function updateShopVoucherDisplay() {\r\n");
      out.write("        const container = document.getElementById('shopVoucherStatus');\r\n");
      out.write("        const v = shopVouchers.find(x => x.id === selectedShopVoucherId);\r\n");
      out.write("        if (v) {\r\n");
      out.write("            container.innerHTML = '<span class=\"voucher-applied-tag\"><i class=\"fa-solid fa-check-circle\"></i> ' + v.label + '</span>'\r\n");
      out.write("                + '<a href=\"javascript:void(0)\" class=\"voucher-change-link\" onclick=\"showVoucherModal()\">Thay đổi</a>';\r\n");
      out.write("        } else {\r\n");
      out.write("            container.innerHTML = '<a href=\"javascript:void(0)\" class=\"voucher-select-link\" onclick=\"showVoucherModal()\">Chọn Voucher</a>';\r\n");
      out.write("        }\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function applyShopVoucherCode() {\r\n");
      out.write("        const code = document.getElementById('shopVoucherCode').value.trim().toUpperCase();\r\n");
      out.write("        if (!code) return;\r\n");
      out.write("        const found = shopVouchers.find(v => v.code === code);\r\n");
      out.write("        if (found) {\r\n");
      out.write("            if (TOTAL_MONEY < found.minOrder) {\r\n");
      out.write("                alert('Đơn hàng chưa đạt giá trị tối thiểu ' + formatVND(found.minOrder));\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            tempShopVoucherId = found.id;\r\n");
      out.write("            renderShopVouchers();\r\n");
      out.write("            document.getElementById('shopVoucherCode').value = '';\r\n");
      out.write("        } else {\r\n");
      out.write("            alert('Mã voucher không hợp lệ!');\r\n");
      out.write("        }\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    // ===== PLATFORM VOUCHER MODAL =====\r\n");
      out.write("    function renderPlatformVouchers() {\r\n");
      out.write("        const container = document.getElementById('platformVoucherList');\r\n");
      out.write("        container.innerHTML = '';\r\n");
      out.write("        platformVouchers.forEach(v => {\r\n");
      out.write("            const eligible = TOTAL_MONEY >= v.minOrder;\r\n");
      out.write("            const isSelected = v.id === tempPlatformVoucherId;\r\n");
      out.write("            const iconClass = v.type === 'freeship' ? 'fa-truck' : 'fa-tag';\r\n");
      out.write("            const html = ''\r\n");
      out.write("                + '<div class=\"voucher-card ' + (isSelected ? 'selected' : '') + ' ' + (!eligible ? 'disabled' : '') + '\" onclick=\"' + (eligible ? 'selectPlatformVoucher(\\'' + v.id + '\\')' : '') + '\">'\r\n");
      out.write("                + '  <div class=\"voucher-card-left platform\">'\r\n");
      out.write("                + '    <div class=\"voucher-card-icon\"><i class=\"fa-solid ' + iconClass + '\"></i></div>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '  <div class=\"voucher-card-body\">'\r\n");
      out.write("                + '    <div class=\"voucher-card-title\">' + v.label + '</div>'\r\n");
      out.write("                + '    <div class=\"voucher-card-desc\">' + v.desc + '</div>'\r\n");
      out.write("                + '    <div class=\"voucher-card-code\">Mã: ' + v.code + '</div>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '  <div class=\"voucher-card-radio\">'\r\n");
      out.write("                + '    <input type=\"radio\" name=\"platVoucherSelect\" ' + (isSelected ? 'checked' : '') + ' ' + (!eligible ? 'disabled' : '') + '>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '</div>';\r\n");
      out.write("            container.insertAdjacentHTML('beforeend', html);\r\n");
      out.write("        });\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function selectPlatformVoucher(id) {\r\n");
      out.write("        tempPlatformVoucherId = (tempPlatformVoucherId === id) ? null : id;\r\n");
      out.write("        renderPlatformVouchers();\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function showPlatformVoucherModal() {\r\n");
      out.write("        tempPlatformVoucherId = selectedPlatformVoucherId;\r\n");
      out.write("        renderPlatformVouchers();\r\n");
      out.write("        document.getElementById('platformVoucherModal').classList.add('show');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function closePlatformVoucherModal() {\r\n");
      out.write("        document.getElementById('platformVoucherModal').classList.remove('show');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function confirmPlatformVoucher() {\r\n");
      out.write("        selectedPlatformVoucherId = tempPlatformVoucherId;\r\n");
      out.write("        updatePlatformVoucherDisplay();\r\n");
      out.write("        updateSummary();\r\n");
      out.write("        closePlatformVoucherModal();\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function updatePlatformVoucherDisplay() {\r\n");
      out.write("        const container = document.getElementById('platformVoucherStatus');\r\n");
      out.write("        const v = platformVouchers.find(x => x.id === selectedPlatformVoucherId);\r\n");
      out.write("        if (v) {\r\n");
      out.write("            container.innerHTML = '<span class=\"voucher-applied-tag platform-tag\"><i class=\"fa-solid fa-check-circle\"></i> ' + v.label + '</span>'\r\n");
      out.write("                + '<a href=\"javascript:void(0)\" class=\"voucher-change-link\" onclick=\"showPlatformVoucherModal()\">Thay đổi</a>';\r\n");
      out.write("        } else {\r\n");
      out.write("            container.innerHTML = '<a href=\"javascript:void(0)\" class=\"pv-link\" onclick=\"showPlatformVoucherModal()\">Chọn hoặc nhập mã</a>';\r\n");
      out.write("        }\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function applyPlatformVoucherCode() {\r\n");
      out.write("        const code = document.getElementById('platformVoucherCode').value.trim().toUpperCase();\r\n");
      out.write("        if (!code) return;\r\n");
      out.write("        const found = platformVouchers.find(v => v.code === code);\r\n");
      out.write("        if (found) {\r\n");
      out.write("            if (TOTAL_MONEY < found.minOrder) {\r\n");
      out.write("                alert('Đơn hàng chưa đạt giá trị tối thiểu ' + formatVND(found.minOrder));\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            tempPlatformVoucherId = found.id;\r\n");
      out.write("            renderPlatformVouchers();\r\n");
      out.write("            document.getElementById('platformVoucherCode').value = '';\r\n");
      out.write("        } else {\r\n");
      out.write("            alert('Mã voucher không hợp lệ!');\r\n");
      out.write("        }\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    // ===== SHIPPING MODAL =====\r\n");
      out.write("    function renderShippingOptions() {\r\n");
      out.write("        const container = document.getElementById('shippingOptionsList');\r\n");
      out.write("        container.innerHTML = '';\r\n");
      out.write("        shippingMethods.forEach(s => {\r\n");
      out.write("            const isSelected = s.id === tempShippingId;\r\n");
      out.write("            const html = ''\r\n");
      out.write("                + '<div class=\"shipping-option-card ' + (isSelected ? 'selected' : '') + '\" onclick=\"selectShippingOption(\\'' + s.id + '\\')\">'\r\n");
      out.write("                + '  <div class=\"shipping-opt-radio\">'\r\n");
      out.write("                + '    <input type=\"radio\" name=\"shippingSelect\" ' + (isSelected ? 'checked' : '') + '>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '  <div class=\"shipping-opt-icon\" style=\"color:' + s.color + '\"><i class=\"fa-solid ' + s.icon + '\"></i></div>'\r\n");
      out.write("                + '  <div class=\"shipping-opt-body\">'\r\n");
      out.write("                + '    <div class=\"shipping-opt-name\">' + s.name + '</div>'\r\n");
      out.write("                + '    <div class=\"shipping-opt-est\">' + s.estText + '</div>'\r\n");
      out.write("                + '    <div class=\"shipping-opt-time\"><i class=\"fa-regular fa-clock\"></i> ' + s.est + '</div>'\r\n");
      out.write("                + '  </div>'\r\n");
      out.write("                + '  <div class=\"shipping-opt-fee\">' + formatVND(s.fee) + '</div>'\r\n");
      out.write("                + '</div>';\r\n");
      out.write("            container.insertAdjacentHTML('beforeend', html);\r\n");
      out.write("        });\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function selectShippingOption(id) {\r\n");
      out.write("        tempShippingId = id;\r\n");
      out.write("        renderShippingOptions();\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function showShippingModal() {\r\n");
      out.write("        tempShippingId = selectedShippingId;\r\n");
      out.write("        renderShippingOptions();\r\n");
      out.write("        document.getElementById('shippingModal').classList.add('show');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function closeShippingModal() {\r\n");
      out.write("        document.getElementById('shippingModal').classList.remove('show');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function confirmShipping() {\r\n");
      out.write("        selectedShippingId = tempShippingId;\r\n");
      out.write("        updateShippingDisplay();\r\n");
      out.write("        updateSummary();\r\n");
      out.write("        closeShippingModal();\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function updateShippingDisplay() {\r\n");
      out.write("        const ship = shippingMethods.find(s => s.id === selectedShippingId);\r\n");
      out.write("        if (!ship) return;\r\n");
      out.write("        document.getElementById('shippingTypeName').textContent = ship.name;\r\n");
      out.write("        document.getElementById('shippingTypeName').style.color = ship.color;\r\n");
      out.write("        document.getElementById('shippingEst').textContent = ship.estText;\r\n");
      out.write("        document.getElementById('shippingFeeText').textContent = formatVND(ship.fee);\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    // ===== PAYMENT METHOD =====\r\n");
      out.write("    document.querySelectorAll('.payment-option').forEach(opt => {\r\n");
      out.write("        opt.addEventListener('click', function() {\r\n");
      out.write("            document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));\r\n");
      out.write("            this.classList.add('active');\r\n");
      out.write("            this.querySelector('input[type=\"radio\"]').checked = true;\r\n");
      out.write("            const codNotice = document.getElementById('codNotice');\r\n");
      out.write("            codNotice.style.display = this.dataset.method === 'cod' ? 'flex' : 'none';\r\n");
      out.write("        });\r\n");
      out.write("    });\r\n");
      out.write("\r\n");
      out.write("    // ===== ADDRESS MANAGEMENT =====\r\n");
      out.write("    let currentAddrType = 'Nhà Riêng';\r\n");
      out.write("    let addresses = [\r\n");
      out.write("        {\r\n");
      out.write("            id: 1,\r\n");
      out.write("            name: \"");
      out.print( user.getFullName() );
      out.write("\",\r\n");
      out.write("            phone: \"");
      out.print( user.getPhone() != null ? user.getPhone() : "(chưa có SĐT)" );
      out.write("\",\r\n");
      out.write("            detailText: \"Phường Đống Đa, Thành Phố Quy Nhơn, Bình Định\",\r\n");
      out.write("            specificText: \"227/09 lê thanh nghị\",\r\n");
      out.write("            isDefault: true,\r\n");
      out.write("            type: \"Nhà Riêng\"\r\n");
      out.write("        }\r\n");
      out.write("    ];\r\n");
      out.write("    let selectedAddressId = 1;\r\n");
      out.write("    let tempSelectedAddressId = 1;\r\n");
      out.write("\r\n");
      out.write("    function renderAddressList() {\r\n");
      out.write("        const container = document.getElementById('addressListContainer');\r\n");
      out.write("        container.innerHTML = '';\r\n");
      out.write("        addresses.forEach(addr => {\r\n");
      out.write("            const isChecked = addr.id === tempSelectedAddressId ? 'checked' : '';\r\n");
      out.write("            const isSelected = addr.id === tempSelectedAddressId ? 'selected' : '';\r\n");
      out.write("            const defaultBadge = addr.isDefault ? '<span class=\"address-badge-sm\">Mặc định</span>' : '';\r\n");
      out.write("            const html = ''\r\n");
      out.write("                + '<div class=\"address-item ' + isSelected + '\" onclick=\"selectAddressItem(' + addr.id + ')\">'\r\n");
      out.write("                + '    <div class=\"address-radio\">'\r\n");
      out.write("                + '        <input type=\"radio\" name=\"addressSelect\" ' + isChecked + '>'\r\n");
      out.write("                + '        <span class=\"custom-radio\"></span>'\r\n");
      out.write("                + '    </div>'\r\n");
      out.write("                + '    <div class=\"address-content\">'\r\n");
      out.write("                + '        <div class=\"address-item-info-top\">'\r\n");
      out.write("                + '            <span class=\"ai-name\">' + addr.name + '</span>'\r\n");
      out.write("                + '            <span class=\"ai-phone\">' + addr.phone + '</span>'\r\n");
      out.write("                + '            <a href=\"javascript:void(0)\" class=\"btn-update-addr\">Cập nhật</a>'\r\n");
      out.write("                + '        </div>'\r\n");
      out.write("                + '        <div class=\"ai-detail-wrap\">'\r\n");
      out.write("                + '            <div class=\"ai-detail\">' + addr.specificText + '</div>'\r\n");
      out.write("                + '            <div class=\"ai-detail\">' + addr.detailText + '</div>'\r\n");
      out.write("                + '            ' + defaultBadge\r\n");
      out.write("                + '        </div>'\r\n");
      out.write("                + '    </div>'\r\n");
      out.write("                + '</div>';\r\n");
      out.write("            container.insertAdjacentHTML('beforeend', html);\r\n");
      out.write("        });\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function selectAddressItem(id) { tempSelectedAddressId = id; renderAddressList(); }\r\n");
      out.write("    function showAddressModal() { tempSelectedAddressId = selectedAddressId; renderAddressList(); document.getElementById('addressModal').classList.add('show'); }\r\n");
      out.write("    function closeAddressModal() { document.getElementById('addressModal').classList.remove('show'); }\r\n");
      out.write("    function confirmAddressSelection() { selectedAddressId = tempSelectedAddressId; updateMainAddressDisplay(); closeAddressModal(); }\r\n");
      out.write("\r\n");
      out.write("    function updateMainAddressDisplay() {\r\n");
      out.write("        const addr = addresses.find(a => a.id === selectedAddressId);\r\n");
      out.write("        if(!addr) return;\r\n");
      out.write("        const container = document.getElementById('selectedAddressContainer');\r\n");
      out.write("        const defaultBadge = addr.isDefault ? '<span class=\"address-badge\">Mặc định</span>' : '';\r\n");
      out.write("        container.innerHTML = ''\r\n");
      out.write("            + '<div class=\"address-info\">'\r\n");
      out.write("            + '    <span class=\"address-name\">' + addr.name + '</span>'\r\n");
      out.write("            + '    <span class=\"address-phone\">' + addr.phone + '</span>'\r\n");
      out.write("            + '    ' + defaultBadge\r\n");
      out.write("            + '</div>'\r\n");
      out.write("            + '<div class=\"address-detail\">'\r\n");
      out.write("            + '    <span class=\"address-text\">' + addr.specificText + ', ' + addr.detailText + '</span>'\r\n");
      out.write("            + '    <button type=\"button\" class=\"btn-change\" onclick=\"showAddressModal()\">Thay Đổi</button>'\r\n");
      out.write("            + '</div>';\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function showNewAddressModal() { closeAddressModal(); document.getElementById('newAddressModal').classList.add('show'); }\r\n");
      out.write("    function closeNewAddressModal() { document.getElementById('newAddressModal').classList.remove('show'); showAddressModal(); }\r\n");
      out.write("    function selectAddrType(btn, type) { document.querySelectorAll('.btn-addr-type').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentAddrType = type; }\r\n");
      out.write("\r\n");
      out.write("    function saveNewAddress() {\r\n");
      out.write("        const name = document.getElementById('newAddrName').value;\r\n");
      out.write("        const phone = document.getElementById('newAddrPhone').value;\r\n");
      out.write("        const city = document.getElementById('newAddrCity').value;\r\n");
      out.write("        const detail = document.getElementById('newAddrDetail').value;\r\n");
      out.write("        const isDefault = document.getElementById('newAddrDefault').checked;\r\n");
      out.write("        if(!name || !phone || !city || !detail) { alert('Vui lòng điền đầy đủ thông tin!'); return; }\r\n");
      out.write("        if(isDefault) { addresses.forEach(a => a.isDefault = false); }\r\n");
      out.write("        const newAddr = { id: Date.now(), name, phone: \"(+84) \" + phone.replace(/^0/, ''), detailText: city, specificText: detail, isDefault, type: currentAddrType };\r\n");
      out.write("        addresses.push(newAddr);\r\n");
      out.write("        tempSelectedAddressId = newAddr.id;\r\n");
      out.write("        document.getElementById('newAddrName').value = '';\r\n");
      out.write("        document.getElementById('newAddrPhone').value = '';\r\n");
      out.write("        document.getElementById('newAddrCity').value = '';\r\n");
      out.write("        document.getElementById('newAddrDetail').value = '';\r\n");
      out.write("        document.getElementById('newAddrDefault').checked = false;\r\n");
      out.write("        closeNewAddressModal();\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    // ===== INIT =====\r\n");
      out.write("    document.addEventListener('DOMContentLoaded', () => {\r\n");
      out.write("        updateMainAddressDisplay();\r\n");
      out.write("        updateShippingDisplay();\r\n");
      out.write("        updateSummary();\r\n");
      out.write("    });\r\n");
      out.write("\r\n");
      out.write("    // Close any modal on overlay click\r\n");
      out.write("    document.querySelectorAll('.modal-overlay').forEach(overlay => {\r\n");
      out.write("        overlay.addEventListener('click', function(e) {\r\n");
      out.write("            if (e.target === this) this.classList.remove('show');\r\n");
      out.write("        });\r\n");
      out.write("    });\r\n");
      out.write("</script>\r\n");
      out.write("\r\n");
      out.write("</body>\r\n");
      out.write("</html>\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof jakarta.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
